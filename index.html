<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Online Snake (SSE)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background: #f8fbf7; color: #1a1a1a; }
    .hero {
      display: flex;
      align-items: center;
      gap: 16px;
      border: 1px solid #d9e6d2;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 16px;
      background: #ffffff;
    }
    .hero img {
      width: 72px;
      height: 72px;
      object-fit: contain;
      border-radius: 10px;
      background: #eef6e9;
      padding: 6px;
    }
    .hero h1 { margin: 0 0 6px 0; font-size: 26px; }
    .hero p { margin: 0; color: #2f4730; }
    .layout { display: flex; gap: 16px; align-items: flex-start; }
    #left { width: 260px; flex: 0 0 260px; }
    #game { flex: 1; }
    #game-board-wrap {
      overflow: auto;
      max-width: 100%;
      padding-bottom: 4px;
    }

    #game-board {
      display: grid;
      gap: 1px;
      background: #ccc;
      width: max-content;
      user-select: none;
    }
    .cell {
      width: 18px;
      height: 18px;
      background: #f3f3f3;
    }
    .food { background: #ff4444 !important; }

    .snake-cell { background: #00aa00; }

    .panel { border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
    .row { margin: 6px 0; }
    input { width: 100%; padding: 6px; }
    button { padding: 8px 10px; cursor: pointer; }

    .snake-item {
      border: 1px solid #ddd;
      padding: 8px;
      border-radius: 8px;
      margin: 6px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .snake-item.active { outline: 2px solid #333; }
    .badge { width: 16px; height: 16px; border-radius: 4px; display: inline-block; margin-right: 8px; }
    small { color: #666; }

    @media (max-width: 980px) {
      .layout {
        flex-direction: column;
      }
      #left {
        width: 100%;
        flex: 1 1 auto;
      }
      #game {
        width: 100%;
      }
    }

    @media (max-width: 640px) {
      body {
        margin: 10px;
      }
      .hero {
        flex-direction: column;
        align-items: flex-start;
      }
      .hero img {
        width: 64px;
        height: 64px;
      }
    }
  </style>
</head>
<body>
  <div class="hero">
    <img src="src/images/snake_logo.png" alt="Terrarium Snake Club logo" />
    <div>
      <h1>Terrarium Snake Club</h1>
      <p>Welcome to the new world of gaming! We are currently testing the project, and it will be available very soon. Keep checking back!</p>
    </div>
  </div>

  <div class="layout">
  <div id="left">
    <div class="panel">
      <div class="row"><strong>Login (optional)</strong></div>
      <div class="row"><input id="username" placeholder="username (user1)" /></div>
      <div class="row"><input id="password" type="password" placeholder="password (pass1)" /></div>
      <div class="row"><button id="loginBtn">Login</button></div>
      <div class="row"><small id="authStatus">Not logged in (watch-only)</small></div>
    </div>

    <div class="panel">
      <div class="row"><strong>My Snakes</strong></div>
      <div id="mySnakes"></div>
      <div class="row"><button id="createSnakeBtn" disabled>Create Snake</button></div>
      <div class="row"><small>Controls: W/A/S/D move selected snake, P pause selected snake</small></div>
    </div>
  </div>

  <div id="game">
    <div class="panel">
      <div><strong>Live Game</strong></div>
      <div>Tick: <span id="tick">0</span></div>
    </div>
    <div id="game-board-wrap">
      <div id="game-board"></div>
    </div>
  </div>
  </div>

<script>
  const API = window.location.protocol === "file:" ? "http://127.0.0.1:8080" : window.location.origin;

  let token = null;
  let myUserId = null;
  let selectedSnakeId = null;

  let gridW = 40, gridH = 20;
  let cells = [];

  const board = document.getElementById("game-board");
  const tickEl = document.getElementById("tick");
  const authStatus = document.getElementById("authStatus");
  const mySnakesEl = document.getElementById("mySnakes");
  const createSnakeBtn = document.getElementById("createSnakeBtn");

  function buildBoard(w, h) {
    gridW = w; gridH = h;
    board.style.gridTemplateColumns = `repeat(${w}, 18px)`;
    board.innerHTML = "";
    cells = [];
    for (let i = 0; i < w*h; i++) {
      const c = document.createElement("div");
      c.className = "cell";
      board.appendChild(c);
      cells.push(c);
    }
  }

  function idx(x,y){ return y*gridW + x; }

  function clearBoard() {
    for (const c of cells) {
      c.className = "cell";
      c.style.background = ""; // allow custom snake colors
    }
  }

  function drawFrame(state) {
    tickEl.textContent = state.tick;

    if (state.w !== gridW || state.h !== gridH || cells.length === 0) {
      buildBoard(state.w, state.h);
    }

    clearBoard();

    // foods
    for (const f of state.foods) {
      const i = idx(f.x, f.y);
      if (cells[i]) cells[i].classList.add("food");
    }

    // snakes
    for (const s of state.snakes) {
      for (const seg of s.body) {
        const i = idx(seg.x, seg.y);
        if (!cells[i]) continue;
        cells[i].classList.add("snake-cell");
        // color each snake
        cells[i].style.background = s.color;
      }
    }
  }

  async function api(path, opts={}) {
    const headers = opts.headers || {};
    headers["Content-Type"] = "application/json";
    if (token) headers["Authorization"] = "Bearer " + token;
    const res = await fetch(API + path, { ...opts, headers });
    return res;
  }

  async function login() {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();

    const res = await fetch(API + "/auth/login", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({username, password})
    });

    if (!res.ok) {
      authStatus.textContent = "Login failed";
      return;
    }
    const data = await res.json();
    token = data.token;
    myUserId = data.user_id;

    authStatus.textContent = `Logged in as user_id=${myUserId}`;
    createSnakeBtn.disabled = false;

    await loadMySnakes();
  }

  async function loadMySnakes() {
    if (!token) return;
    const res = await api("/me/snakes");
    if (!res.ok) return;
    const data = await res.json();

    mySnakesEl.innerHTML = "";
    for (const s of data.snakes) {
      const div = document.createElement("div");
      div.className = "snake-item" + (s.id === selectedSnakeId ? " active" : "");
      div.onclick = () => {
        selectedSnakeId = s.id;
        loadMySnakes();
      };
      div.innerHTML = `
        <span><span class="badge" style="background:${s.color}"></span>Snake #${s.id}</span>
        <small>${s.paused ? "paused" : "moving"} Â· len ${s.len}</small>
      `;
      mySnakesEl.appendChild(div);
    }

    if (!selectedSnakeId && data.snakes.length > 0) selectedSnakeId = data.snakes[0].id;
  }

  async function createSnake() {
    if (!token) return;
    // random-ish color
    const color = "#" + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0');
    const res = await api("/me/snakes", { method:"POST", body: JSON.stringify({color}) });
    if (!res.ok) {
      const t = await res.text();
      alert("Create snake failed: " + t);
      return;
    }
    await loadMySnakes();
  }

  async function setDir(dir) {
    if (!token || !selectedSnakeId) return;
    await api(`/snakes/${selectedSnakeId}/dir`, { method:"POST", body: JSON.stringify({dir}) });
  }

  async function togglePause() {
    if (!token || !selectedSnakeId) return;
    await api(`/snakes/${selectedSnakeId}/pause`, { method:"POST" });
    await loadMySnakes();
  }

  // Input
  document.addEventListener("keydown", async (e) => {
    const k = e.key.toLowerCase();
    if (["w","a","s","d","p"].includes(k)) e.preventDefault();

    if (k === "w") return setDir(3);
    if (k === "a") return setDir(1);
    if (k === "s") return setDir(4);
    if (k === "d") return setDir(2);
    if (k === "p") return togglePause();
  });

  document.getElementById("loginBtn").onclick = login;
  document.getElementById("createSnakeBtn").onclick = createSnake;

  // SSE stream (watchers scale well)
  function startStream() {
    const es = new EventSource(API + "/game/stream");
    es.addEventListener("frame", (ev) => {
      const state = JSON.parse(ev.data);
      drawFrame(state);
    });
    es.onerror = () => {
      // auto reconnect
      es.close();
      setTimeout(startStream, 1000);
    };
  }

  startStream();
</script>
</body>
</html>
